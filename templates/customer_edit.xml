<odoo>
    <template id="customer_update">
        <t t-call="website.layout">
            <t t-set="title">Bus Route รถบริการเส้นทาง</t>
            <div class="container">

                <!-- ส่วนของฟอร์ม -->
                <form t-attf-action="/customer/update" enctype="multipart/form-data" method="POST" class="mt-4">
                    <!-- <input type="hidden" name="txt_id" t-attf-value="{{ data.id }}"/> -->
                    <div class="form-group" style="display: flex; align-items: center;">
                        <label style="margin-right: 10px;">สายรถ</label>
                        <t t-if="bus">
                            <select name="txt_name" class="form-control" style="width: 10%; margin-right: 10px;">
                                <option value="">กรุณาเลือก</option>
                                <t t-foreach="allbus" t-as="abus">
                                    <option t-att-value="abus.name" t-att-selected="abus.name == bus.name">
                                        <t t-esc="abus.name"/>
                                    </option>
                                </t>
                            </select>
                        </t>
                        <t t-else="">
                            <select name="txt_name" class="form-control" style="width: 10%; margin-right: 10px;">
                                <option value="">กรุณาเลือก</option>
                                <t t-foreach="allbus" t-as="abus">
                                    <option t-att-value="abus.name">
                                        <t t-esc="abus.name"/>
                                    </option>
                                </t>
                            </select>
                        </t>
                        <button type="submit" class="btn btn-primary">ค้นหารถ</button>
                    </div>
                </form>


                <t t-if="bus">
                    <t t-if="bus.latitude and bus.longtitude">
                        <input type="hidden" t-attf-value="{{ bus.name }}" id="name_bus"/>
                        <input type="hidden" t-attf-value="{{ bus.latitude }}" id="latitude"/>
                        <input type="hidden" t-attf-value="{{ bus.longtitude }}" id="longtitude"/>
                    </t>
                </t>
                <!-- ส่วนของแผนที่ Longdo -->
                <div id="map" style="height: 550px; margin-top: 10px;"></div>
                <div id="result"
                     style="position: absolute; top: 0; bottom: 0; right: 0; width: 1px; height: 80%; margin: auto; border: 4px solid #dddddd; background: #ffffff; overflow: auto; z-index: 2;"></div>

                <!-- Include Longdo Map API -->
                <script type="text/javascript"
                        src="https://api.longdo.com/map/?key=ef8e2b805bd26f8d69b291446b10d67d"></script>

            </div>
            <body>
                <div id="map" class="m-4"></div>
            </body>
        </t>

        <script type="text/javascript">
            var map;
            var station1;
            var name_bus;
            let longtitude;
            let latitude;
            var car;
            var xsum = 0;
            var ysum = 0;

            map = new longdo.Map({
            placeholder: document.getElementById('map')
            });
            // ราชภัช สงขลา
            //map.location({ lon:100.613034, lat:7.167384 }, true);
            map.location({ lon:100.66, lat:13.8097 }, true);
            map.zoom(16, true);

            // กำหนดขอบเขตของแผนที่ (bounding box) ในรูปแบบของพิกัด
            var bounds = new longdo.Bounds(
            new longdo.LatLng(13.816201, 100.655515), // พิกัดมุมบนซ้าย  13.816201, 100.655515
            new longdo.LatLng(13.810888, 100.663304) // พิกัดมุมล่างขวา  13.810888, 100.663304
            );

            // ตั้งค่าให้แผนที่สามารถแสดงผลได้เฉพาะในขอบเขตนี้
            map.setBounds(bounds);

            map.Event.bind(longdo.EventName.Zoom, function() {
            var result = map.zoom()
            console.log("Zoom" ,result);
            if (result &lt; 16){
            map.zoom(16, true);
            map.location({ lon:100.66, lat:13.8097 }, true);
            }
            console.log(result);
            });


            //station
            station1 = new longdo.Marker({ lon: 100.613034, lat: 7.167384 },{
            title: 'Custom Marker',
            icon: {
            html: '<b>อาคาร วิทย์</b>',
            offset: { x: 50, y: 80 }
            },
            popup: {
            html: '<div style="background: #eeeeff;">popup</div>'
            }
            });
            map.Overlays.add(station1);
            // end marker

            name_bus = document.getElementById("name_bus").value
            longtitude = document.getElementById("longtitude").value
            latitude = document.getElementById("latitude").value
            if(!latitude){
            latitude=13.898285
            }
            if(!longtitude){
            longtitude=100.537149
            }

            //map.Route.add(new longdo.Marker({ lon: longtitude, lat: latitude},
            //{
            //title: 'Bus',
            //detail: 'I\'m here'
            //}
            //));
        </script>
        <script>

            function fetchLocation() {
            // รับค่า name จาก input field

            // ส่ง POST request ไปยัง '/get_location' พร้อมกับข้อมูล 'name'
            fetch('/get_location', {
            method: 'POST', // ใช้ POST method
            headers: {
            'Content-Type': 'application/json', // ส่งข้อมูลในรูปแบบ JSON
            },
            body: JSON.stringify({
            name: name_bus // ส่ง 'name' ที่รับมาจาก input field
            })
            })
            .then(response => response.json()) // รับข้อมูลตอบกลับเป็น JSON
            .then(data => {
            console.log(data.result);
            if (name_bus) {
            // แปลงข้อมูล result ที่เป็นสตริง JSON ให้เป็นอ็อบเจ็กต์
            const locationData = JSON.parse(data.result);

            longtitude = locationData.longtitude;
            latitude = locationData.latitude;

            // ลบ Marker เดิมที่แสดงอยู่บนแผนที่
            map.Overlays.remove(car);

            // สร้าง Marker ใหม่จากข้อมูลที่ได้รับ
            car = new longdo.Marker({ lon: longtitude, lat: latitude }, {
            title: 'Bus'
            });

            // เพิ่ม Marker ใหม่ลงแผนที่
            map.Overlays.add(car);

            console.log("Updated position: " + longtitude + ", " + latitude);
            } else {
            console.log("Not Found Bus name ;(");
            }
            })
            .catch(error => {
            console.error('Error fetching location:', error);
            });
            }

            // เรียกฟังก์ชันทุกๆ 1 วินาที
            setInterval(fetchLocation, 1000);
        </script>

    </template>
</odoo>
